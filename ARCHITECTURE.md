# ç»Ÿä¸€æ¶æ„æ–‡æ¡£

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é…ç½®æ–‡ä»¶                                 â”‚
â”‚  â€¢ config.yaml (StrategyV6)                                â”‚
â”‚  â€¢ config_v7.yaml (StrategyV7)                             â”‚
â”‚    - strategy.name: 'v6' or 'v7'                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              system.py (ç»Ÿä¸€å…¥å£)                           â”‚
â”‚  â€¢ è¯»å– config['strategy']['name']                         â”‚
â”‚  â€¢ åŠ¨æ€å¯¼å…¥ç­–ç•¥: StrategyV6 æˆ– StrategyV7                   â”‚
â”‚  â€¢ ç»Ÿä¸€æ£€æŸ¥é—´éš”: config.system.check_interval              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Strategy V6           â”‚   â”‚    Strategy V7           â”‚
â”‚    (v6.py)               â”‚   â”‚    (v7.py)               â”‚
â”‚  â€¢ ç®€å•æ­¢ç›ˆæ­¢æŸ           â”‚   â”‚  â€¢ è¿½è¸ªæ­¢æŸ              â”‚
â”‚  â€¢ åˆ†é’Ÿæ£€æŸ¥              â”‚   â”‚  â€¢ MA è¿‡æ»¤               â”‚
â”‚                          â”‚   â”‚  â€¢ åšç©ºè¿‡æ»¤              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MarketClient (ç»Ÿä¸€æ¥å£)                   â”‚
â”‚                                                            â”‚
â”‚  FutuClient                BacktestMarketClient           â”‚
â”‚  (å®ç›˜)                     (å›æµ‹)                         â”‚
â”‚  â”œâ”€ è¿æ¥ FutuOpenD          â”œâ”€ Polygon API (ç§’çº§æ•°æ®)      â”‚
â”‚  â”œâ”€ å®æ—¶è¡Œæƒ…                â”œâ”€ æ—¥çº§ç¼“å­˜                    â”‚
â”‚  â”œâ”€ å®æ—¶äº¤æ˜“                â”œâ”€ æ¨¡æ‹Ÿäº¤æ˜“                    â”‚
â”‚  â””â”€ å®æ—¶æŒä»“                â””â”€ æ»‘ç‚¹/æ‰‹ç»­è´¹                 â”‚
â”‚                                                            â”‚
â”‚  ç»Ÿä¸€æ¥å£:                                                 â”‚
â”‚  â€¢ connect() / disconnect()                               â”‚
â”‚  â€¢ get_stock_price()                                      â”‚
â”‚  â€¢ get_account_info()                                     â”‚
â”‚  â€¢ get_positions()                                        â”‚
â”‚  â€¢ get_minute_ohlc() â† æ–°å¢                               â”‚
â”‚  â€¢ buy_stock() / sell_stock()                             â”‚
â”‚  â€¢ get_order_list()                                       â”‚
â”‚  â€¢ count_trading_days_between()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒåŸåˆ™

### **1. å•ä¸€å…¥å£**
- âœ… åªæœ‰ä¸€ä¸ª `system.py`ï¼ˆåˆ é™¤äº† `system_v7.py`ï¼‰
- âœ… æ ¹æ®é…ç½®åŠ¨æ€é€‰æ‹©ç­–ç•¥
- âœ… å®ç›˜å’Œå›æµ‹å…±ç”¨ç›¸åŒçš„ç³»ç»Ÿä»£ç 

### **2. æ¥å£ç»Ÿä¸€**
- âœ… `FutuClient` å’Œ `BacktestMarketClient` å®Œå…¨ä¸€è‡´çš„æ¥å£
- âœ… ç­–ç•¥ä»£ç ä¸æ„ŸçŸ¥åº•å±‚æ˜¯å®ç›˜è¿˜æ˜¯å›æµ‹
- âœ… åªéœ€åˆ‡æ¢ clientï¼Œç­–ç•¥ä»£ç é›¶ä¿®æ”¹

### **3. é…ç½®é©±åŠ¨**
- âœ… æ‰€æœ‰å‚æ•°é€šè¿‡ `config_v7.yaml` ç»´æŠ¤
- âœ… `strategy.name` æ§åˆ¶ä½¿ç”¨å“ªä¸ªç­–ç•¥
- âœ… `system.check_interval` æ§åˆ¶æ£€æŸ¥é¢‘ç‡ï¼ˆ20ç§’ï¼‰

---

## ä½¿ç”¨æ–¹æ³•

### **å®ç›˜äº¤æ˜“ï¼ˆä½¿ç”¨ V7 ç­–ç•¥ï¼‰**

```bash
python -m tradingsystem.system --config config_v7.yaml
```

**å†…éƒ¨æµç¨‹ï¼š**
1. åŠ è½½ `config_v7.yaml`
2. è¯»å– `strategy.name = 'v7'`
3. åŠ¨æ€å¯¼å…¥ `StrategyV7`
4. ä½¿ç”¨ `FutuClient` è¿æ¥å®ç›˜
5. æ¯ 20 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆ`check_interval: 20`ï¼‰

---

### **å›æµ‹ï¼ˆä½¿ç”¨ V7 ç­–ç•¥ï¼‰**

```bash
python run_backtest_v7.py --config config_v7.yaml --cash 1000000
```

**å†…éƒ¨æµç¨‹ï¼š**
1. åŠ è½½ `config_v7.yaml`
2. è¯»å– `strategy.name = 'v7'`
3. åŠ¨æ€å¯¼å…¥ `StrategyV7`
4. ä½¿ç”¨ `BacktestMarketClient` + Polygon API
5. æ¯ 20 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆä¸å®ç›˜ä¸€è‡´ï¼‰

---

## æ¥å£å¯¹ç…§è¡¨

| æ–¹æ³• | FutuClient | BacktestMarketClient | è¯´æ˜ |
|------|-----------|---------------------|------|
| `connect()` | è¿æ¥ FutuOpenD | æ¨¡æ‹Ÿè¿æ¥ | âœ… |
| `disconnect()` | æ–­å¼€è¿æ¥ | è®°å½•ç»Ÿè®¡ | âœ… |
| `get_stock_price(symbol)` | å®æ—¶æŠ¥ä»· | Polygon API | âœ… |
| `get_minute_ohlc(symbol)` | å®æ—¶ OHLC | å½“å‰ä»·æ ¼ | âœ… |
| `get_account_info()` | æŸ¥è¯¢è´¦æˆ· | æ¨¡æ‹Ÿè´¦æˆ· | âœ… |
| `get_positions()` | å®æ—¶æŒä»“ | æ¨¡æ‹ŸæŒä»“ | âœ… |
| `buy_stock()` | ä¸‹ä¹°å• | æ¨¡æ‹Ÿä¹°å…¥ + æ»‘ç‚¹ | âœ… |
| `sell_stock()` | ä¸‹å–å• | æ¨¡æ‹Ÿå–å‡º + æ»‘ç‚¹ | âœ… |
| `get_order_list()` | æŸ¥è¯¢è®¢å• | è®¢å•è®°å½• | âœ… |
| `count_trading_days_between()` | Futu API | Polygon + ç¼“å­˜ | âœ… |
| `set_current_time()` | N/A | è®¾ç½®å›æµ‹æ—¶é—´ | å›æµ‹ä¸“ç”¨ |

---

## æ•°æ®æµæ—¶åŒºç»Ÿä¸€

**æ‰€æœ‰æ—¶é—´ç»Ÿä¸€ä¸ºç¾ä¸œæ—¶é—´ï¼ˆETï¼‰ï¼š**

```
CSV æ•°æ® (UTC+8)
  â†’ parser.py è§£ææ—¶è½¬æ¢ä¸º ET
     â†“
Signal (ET)
  â†’ strategy.on_signal()
     â†“
MarketClient (ET)
  â†’ Polygon API (UTC) è‡ªåŠ¨è½¬æ¢ä¸º ET
     â†“
æ‰€æœ‰æ—¥å¿—ã€è®°å½•éƒ½æ˜¯ ET æ—¶é—´
```

---

## å›æµ‹ç‰¹æ€§

### **Polygon API é›†æˆ**
- âœ… ç§’çº§ OHLC æ•°æ®
- âœ… æ—¥çº§ç¼“å­˜ï¼ˆå‡å°‘ API è°ƒç”¨ï¼‰
- âœ… Forward-fill ä»·æ ¼å¡«å……
- âœ… å¸‚åœºå‡æœŸè‡ªåŠ¨è·å–

### **äº¤æ˜“æˆæœ¬æ¨¡æ‹Ÿ**
- âœ… æ»‘ç‚¹: 0.05% (ä¹°å…¥ +0.05%, å–å‡º -0.05%)
- âœ… æ‰‹ç»­è´¹: $0.005/è‚¡ï¼Œæœ€ä½ $1
- âœ… ç°é‡‘æ¯”ç‡é™åˆ¶: -100% (å…è®¸ä¸€å®šè´Ÿç°é‡‘)

### **æ•°æ®ç¼“å­˜**
- **ä»·æ ¼ç¼“å­˜**: `{symbol_date: DataFrame}` (å†…å­˜)
- **å‡æœŸç¼“å­˜**: `database/market_holidays.json` (ç£ç›˜)
- **ç¼“å­˜å‘½ä¸­ç‡**: é€šå¸¸ > 95%

---

## é…ç½®ç¤ºä¾‹

### **config_v7.yaml å…³é”®é…ç½®**

```yaml
system:
  check_interval: 20  # 20ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆå®ç›˜å’Œå›æµ‹ä¸€è‡´ï¼‰

strategy:
  name: 'v7'  # ä½¿ç”¨ StrategyV7
  
  filter:
    entry_delay: 1  # ä¿¡å·åå»¶è¿Ÿ 1 åˆ†é’Ÿä¹°å…¥
    min_option_premium: 100000
    
  position_compute:
    max_daily_trades: 8
    max_single_position: 0.3
    
  stop_loss: 0.1
  take_profit: 0.3
  trailing_stop: 0.05
  holding_days: 6
```

---

## éªŒè¯æ¸…å•

âœ… **æ¥å£ä¸€è‡´æ€§**: FutuClient å’Œ BacktestMarketClient æ‰€æœ‰æ–¹æ³•ä¸€è‡´  
âœ… **ç­–ç•¥åŠ¨æ€åŠ è½½**: system.py æ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹© V6/V7  
âœ… **æ—¶åŒºç»Ÿä¸€**: æ‰€æœ‰æ—¶é—´éƒ½æ˜¯ ET  
âœ… **å›æµ‹å®¢æˆ·ç«¯**: Polygon API é›†æˆå®Œæˆ  
âœ… **å¸‚åœºå‡æœŸ**: è‡ªåŠ¨è·å–å¹¶ç¼“å­˜  
âœ… **ä»£ç ç®€æ´**: åˆ é™¤å†—ä½™ä»£ç ï¼Œç»Ÿä¸€æ¶æ„  

---

## ä¸‹ä¸€æ­¥

### **è¿è¡Œå›æµ‹**
```bash
python run_backtest_v7.py --config config_v7.yaml --cash 1000000
```

### **åˆ‡æ¢åˆ°å®ç›˜**
```bash
# 1. å¯åŠ¨ FutuOpenD
# 2. è¿è¡Œç³»ç»Ÿ
python -m tradingsystem.system --config config_v7.yaml
```

**æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œåªéœ€åˆ‡æ¢è¿è¡Œè„šæœ¬ï¼** ğŸš€

---

## æ–‡ä»¶æ¸…å•

### **å·²åˆ é™¤**
- âœ— `future_v_0_1/market/polygon_client.py` (é€»è¾‘å·²é›†æˆ)
- âœ— `future_v_0_1/tradingsystem/system_v7.py` (ç»Ÿä¸€åˆ° system.py)

### **å·²ä¿®æ”¹**
- âœï¸  `future_v_0_1/tradingsystem/system.py` (åŠ¨æ€ç­–ç•¥é€‰æ‹©)
- âœï¸  `future_v_0_1/market/futu_client.py` (æ·»åŠ  get_minute_ohlc)
- âœï¸  `future_v_0_1/market/backtest_client.py` (Polygon é›†æˆ)
- âœï¸  `run_backtest_v7.py` (20ç§’æ£€æŸ¥)

### **å·²åˆ›å»º**
- âœ¨ `.env` (Polygon API Key)
- âœ¨ `test_unified_architecture.py` (æ¶æ„éªŒè¯)
- âœ¨ `ARCHITECTURE.md` (æœ¬æ–‡æ¡£)

---

**æ¶æ„ç»Ÿä¸€å®Œæˆï¼å®ç›˜å›æµ‹ç°åœ¨å®Œå…¨ä¸€è‡´ã€‚** âœ…

