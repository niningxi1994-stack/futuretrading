# 动态止损（Trailing Stop Loss）功能说明

## 功能概述
已添加动态止损机制，在价格从最高点下跌超过指定比例时自动卖出，有效保护利润并限制大幅回落的损失。

## 核心改动

### 1. 配置文件（`config_v8.yaml`）
```yaml
strategy:
  stop_loss: 0.08           # 固定止损 -8%
  take_profit: 0.20         # 止盈 +20%
  trailing_stop_loss: 0.05  # 动态止损：从最高价下跌5%卖出（设为0禁用）
```

### 2. 策略代码（`future_v_0_1/strategy/v8.py`）

#### 初始化阶段
- 读取 `trailing_stop_loss` 配置参数
- 初始化时显示动态止损状态
- 已在 `highest_price_map` 中追踪每个持仓的最高价

#### 出场检查逻辑（优先级顺序）
```
1. ✓ 达到 expiry 日期 + 10:00 AM 卖出
2. ✓ 达到 strike 价格卖出
3. ✓ 动态止损：从最高价下跌 5% 卖出 【新增】
4. ✓ 止盈 +20% 卖出
5. ✓ 固定止损 -8% 卖出
```

## 使用说明

### 启用动态止损
在 `config_v8.yaml` 中设置：
```yaml
trailing_stop_loss: 0.05  # 启用，下跌 5% 时触发
```

### 禁用动态止损
```yaml
trailing_stop_loss: 0.0   # 或注释该行，默认为 0（禁用）
```

### 调整触发幅度
```yaml
trailing_stop_loss: 0.08  # 改为下跌 8% 时触发
trailing_stop_loss: 0.03  # 改为下跌 3% 时触发（更激进）
```

## 工作原理

### 价格追踪
- 买入时：初始最高价 = 买入价格
- 持仓期间：每次检查时更新最高价 = max(历史最高价, 当前价格)

### 触发条件
```
触发价格 = 最高价 × (1 - 下跌幅度)
示例：最高价 $100，下跌 5%
触发价格 = $100 × (1 - 0.05) = $95
```

### 触发场景
- ✓ **正常利润中获利**：买入 $100，涨到 $110（最高），回落到 $104.5
  - 触发价：$110 × 0.95 = $104.5
  - 自动卖出，锁定 +4.5% 收益

- ✓ **限制大幅回落**：买入 $100，涨到 $110（最高），跌到 $104（小幅跌）
  - 触发价：$110 × 0.95 = $104.5
  - 价格 $104 < $104.5，自动卖出

- ✗ **不触发**：买入 $100，一直跌到 $95，没有达到过 $110
  - 最高价始终是 $100
  - 触发价：$100 × 0.95 = $95
  - 价格 $95.50 > $95，不卖出

## 日志输出示例

```
✓ 平仓决策[动态止损]: AAPL 100股 @$104.25
(最高$110.00, 触发阈值$104.50, 从高点下跌4.55%)
```

## 与其他止损的区别

| 类型 | 触发条件 | 适用场景 |
|------|---------|---------|
| **固定止损** | 跌到成本价的 92% | 防止大亏（风险控制） |
| **动态止损** | 从最高价下跌 5% | 保护利润（锁定收益） |
| **止盈** | 涨到成本价的 120% | 目标利润达成 |

## 回测验证步骤

1. **基准对比** - 保持原有配置
   ```bash
   trailing_stop_loss: 0.0  # 禁用
   python run_backtest_v8.py
   ```

2. **启用动态止损** - 启用 5% 下跌幅度
   ```bash
   trailing_stop_loss: 0.05
   python run_backtest_v8.py
   ```

3. **对比结果**
   - 观察触发次数（日志中搜索 "动态止损"）
   - 比较总收益率
   - 分析对不同年份（2023/2024/2025）的影响

## 常见问题

**Q: 为什么没有触发？**
- A: 检查当前价格是否真的低于触发价。例如最高 $100，下跌 5%，需要跌到 $95 以下才触发

**Q: 会和固定止损冲突吗？**
- A: 不会。动态止损在固定止损之前检查，触发后立即卖出并清除元数据，不会重复检查

**Q: 能同时启用吗？**
- A: 可以。两个机制独立工作：
  - 动态止损保护利润（从高点下跌）
  - 固定止损防控风险（从成本价下跌）

**Q: 如何禁用？**
- A: 设置为 `0` 或 `0.0`：
  ```yaml
  trailing_stop_loss: 0  # 禁用
  ```

